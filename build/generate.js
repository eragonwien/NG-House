/**
 * This script generates data based on user input
 * 
 * 1. let the user choose which data are going to be generated 
 * 2. check if variables for test generation is available. if not, abort
 * 3. ask the user to input how many data are going to be generated. user can abort from here.
 * 4. count the current number of data
 * 5. generate data base from the input
 * 6. count the number of generated data
 * 
 * Following test data can be generated:
 * address is generated from ADDRESS, POSTAL_CODE, CITY and LAND
 * 
 * user is generated from USER_NAME. email is firstname_lastname_time@lastname.com
 * for address, all address ids are queried and is randomly chosen.
 * role is always standard which has id of 1
 * 
 * house is generated by querying user , type, address and currency
 * a type is randomly chosen. base on type a specific ranges are generated
 * apartment: 20 - 100m, 1-2 bathrooms, 1-2 bedrooms
 * house: 100 - 500, 1-2 bathrooms, 1-4 bedrooms
 * villa : 500 - 1000, 1-5 bathrooms, 1-5 bedrooms
 * others: min 20 - max. 1000, 1-2 bathrooms, 1-2 bedrooms
 * price = (2000 - 5000) * size
 */
var readline = require('readline-sync');
var dotenv = require('dotenv');
var fs = require('fs');
var helper = require('./helper');
var pool = require('../backend/config/db').pool;
var supportedTypes = ['address', 'user', 'house'];

var userModel = require('../backend/components/user/userModel');
var addressModel = require('../backend/components/address/addressModel');
var houseTypeModel = require('../backend/components/houseType/houseTypeModel');
var currencyModel = require('../backend/components/currency/currencyModel');
var houseModel = require('../backend/components/house/houseModel');
start();

/*  start the data generation
    the user is asked to choose the type of the generated data
*/
function start() {
    console.log('Supported Data: house, user, address');
    var type = readline.question('Which data is going to be generated ? ');
    if (!supportedTypes.includes(type)) {
        return console.log('Type is not supported.')
    }
    prepareGenerating(type);
}

/**
 * checks if the .env file exists 
 * the user is asked for the number of data which are going to be generated
 * @param {string} type The type of the data
 */
function prepareGenerating(type) {
    var path = '.env';
    fs.exists(path, function (fileIsExist) {
        if (!fileIsExist) {
            return console.log('File .env not found. Abort.');
        }
        var count = readline.questionInt('How many data should be generated: ');
        if (count < 0) {
            console.log('The number cannot be smaller than zero. Please try again.')
            return prepareGenerating(type);
        }
        generateData(type, count);
    });
}
/**
 * pass data to generation function
 * @param {string} type type of the generated data
 * @param {number} count number of the data
 */
function generateData(type, count) {
    switch (type) {
        case 'house':
            generateHouse(count);
            break;
        case 'user':
            generateUser(count);
            break;
        case 'address':
            generateAddress(count);
            break;
        default: console.log('Unsupported Type.');
            break;
    }
}

/**
 * generates user
 * first checks if the .env file has variable USER_NAME, cancel process if not
 * query all address ids 
 * create queries to add user to the database
 * @param {number} count number of user being generated
 */
function generateUser(count) {
    if (!process.env.USER_NAME) {
        return finish(null, 'no USER_NAME variables found.');
    }
    var names = helper.getListFromString(process.env.USER_NAME);
    var addressModel = require('../backend/components/address/addressModel');
    addressModel.getAllAddresses(function (error, results) {
        if (error) {
            return console.log(error);
        } 
        // extract only the address id from the results
        var address_ids = helper.filterValuesOfList(results, 'id');
        spawnUsers(count, names, address_ids); 
    });
    
}

/**
 * generate users
 * @param {number} count number of users to be generated
 * @param {string[]} names list of names
 * @param {string[]} addressList list of addresses
 * @param {string[]} successCount number of successful query
 */
function spawnUsers(count, names, addressList, successCount) {
    if (!successCount) {
        successCount = 0;
    }
    if (count <= 0) {
        return finish(null, 'Success: ' + successCount);
    }
    // generates an user object
    var first_name = names[helper.getRandomInt(names.length)];
    var last_name = names[helper.getRandomInt(names.length)];
    var randomValue = helper.getRandomInt(1000);
    var username = first_name + last_name + randomValue;
    var user = {
        role_id: 1,
        first_name: first_name,
        last_name: last_name,
        email: username + '@' + last_name + '.com',
        username: username,
        password: 'test',
        address_id: addressList[helper.getRandomInt(addressList.length)]
    }
    // insert query
    userModel.createUser(user, function (error, result) {
        successCount = (error) ? successCount : successCount + 1;
        count--;
        spawnUsers(count, names, addressList, successCount);
    });
}

/**
 * generates addresses
 * @param {number} count number of addresses
 */
function generateAddress(count) {
    if (!process.env.USER_NAME) {
        return finish(null, 'no USER_NAME variables found.');
    }
    // set postal code length as 4 if no value in .env found
    var postalCodeLength = (process.env.POSTAL_CODE) ? process.env.POSTAL_CODE : 4;
    var names = helper.getListFromString(process.env.USER_NAME);
    // spawn addresses
    spawnAddresses(count, names, postalCodeLength)
}

/**
 * spawns recursively addresses
 * @param {number} count number of addresses
 * @param {string[]} names list of names
 * @param {number} postalCodeLength length of the random postal code
 * @param {number} successCount number of successful actions
 */
function spawnAddresses(count, names, postalCodeLength, successCount) {
    if (!successCount) {
        successCount = 0;
    }
    if (count <= 0) {
        return finish(null, 'Success: ' + successCount);
    }
    // generate an address object
    var address = {
        address: names[helper.getRandomInt(names.length)] + 'Street ' + helper.getRandomInt(100),
        postal_code: helper.getRandomInt(Math.pow(10, postalCodeLength - 1), Math.pow(10, postalCodeLength)),
        city: names[helper.getRandomInt(names.length)] + ' City',
        land: names[helper.getRandomInt(names.length)] + ' Land'
    }
    // insert query
    addressModel.createNewAddress(address, function (error, result) {
        successCount = (error) ? successCount : successCount + 1;
        count--;
        spawnAddresses(count, names, postalCodeLength, successCount);
    });
}

/**
 * generates houses
 * @param {number} count number of houses 
 */
function generateHouse(count) {
    var userIds = [], typeIds = [], addressIds = [], currencyIds = [];
    // get user ids
    userModel.getAllUsers(function (error, users) {
        if (error) {
            return finish(error);
        }
        userIds = helper.filterValuesOfList(users, 'id');
        // get house type ids
        houseTypeModel.getAllHouseType(function (error, types) {
            if (error) {
                return finish(error);
            }
            typeIds = helper.filterValuesOfList(types, 'id');
            // get address ids
            addressModel.getAllAddresses(function (error, addresses) {
                if (error) {
                    return finish(error);
                }
                addressIds = helper.filterValuesOfList(addresses, 'id');
                // get currency ids
                currencyModel.getAllCurrencies(function (error, currencies) {
                    if (error) {
                        return finish(error);
                    }
                    currencyIds = helper.filterValuesOfList(currencies, 'id');
                    // spawn houses
                    spawnHouses(count, userIds, typeIds, addressIds, currencyIds);
                });
            });
        });
    });
}

/**
 * generates houses recursively
 * @param {number} count number of houses to be generated
 * @param {number[]} userIds list of all user ids
 * @param {number[]} typeIds list of all type ids
 * @param {number[]} addressIds list of all address ids
 * @param {number[]} currencyIds list of all currency ids 
 * @param {number} successCount number of successful inserts
 * house is generated by querying user , type, address and currency
 * a type is randomly chosen. base on type a specific ranges are generated
 * size: min 20 - max. 1000, 1-2 bathrooms, 1-2 bedrooms
 * price = (2000 - 5000) * size
 */
function spawnHouses(count, userIds, typeIds, addressIds, currencyIds, successCount) {
    if (!successCount) {
        successCount = 0;
    }
    if (count <= 0) {
        return finish(null, 'Success: ' + successCount);
    }
    // create house
    var bathrooms = helper.getRandomInt(1, 5);
    var bedrooms = helper.getRandomInt(1, 5);
    var rooms = bathrooms + bedrooms + helper.getRandomInt(1, 3);
    var size = helper.getRandomInt(rooms * 10, rooms * 100);
    var price = helper.getRandomInt(200, 1000) * size;
    var house = {
        user_id: userIds[helper.getRandomInt(userIds.length)],
        address_id: addressIds[helper.getRandomInt(addressIds.length)],
        house_type_id: typeIds[helper.getRandomInt(typeIds.length)],
        currency_id: currencyIds[helper.getRandomInt(currencyIds.length)],
        rooms : rooms,
        bathrooms: bathrooms,
        bedrooms: bedrooms,
        size: size,
        price: price
    };
    houseModel.createHouse(house, function (error, result) {
        successCount = (error) ? successCount : successCount + 1;
        count--;
        spawnHouses(count, userIds, typeIds, addressIds, currencyIds, successCount);
    });
}

/**
 * closes the process
 * @param {string} error error message
 * @param {?string} message console message
 */
function finish(error, message) {
    if (error) {
        console.log(error);
    }
    if (message) {
        console.log(message);
    }
    process.exit();
}




